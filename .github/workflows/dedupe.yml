name: Merge and Deduplicate Flashcards

on:
  workflow_dispatch:

jobs:
  merge-and-deduplicate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Merge and deduplicate
      run: |
        python - <<'EOF'
        import csv

        # Input files and output file
        input_files = ['kimshim.txt', 'kim.txt']
        output_file = 'kimshim.txt'

        # Track seen fronts and store unique rows
        seen_fronts = set()
        unique_rows = []
        header = None

        # Read all input files
        for input_file in input_files:
            try:
                with open(input_file, 'r', encoding='utf-8') as f:
                    reader = csv.reader(f)
                    
                    # Read header from first file only
                    file_header = next(reader)
                    if header is None:
                        header = file_header
                        unique_rows.append(header)
                    
                    # Process each row
                    for row in reader:
                        if len(row) >= 2:
                            front = row[0]
                            
                            # Only keep first occurrence of each front
                            if front not in seen_fronts:
                                seen_fronts.add(front)
                                unique_rows.append(row)
                                
                print(f"Processed {input_file}: added rows")
            except FileNotFoundError:
                print(f"Warning: {input_file} not found, skipping...")

        # Write to output file with preserved CSV format
        with open(output_file, 'w', encoding='utf-8', newline='') as f:
            writer = csv.writer(f)
            writer.writerows(unique_rows)

        print(f"\nTotal unique flashcards: {len(unique_rows) - 1}")
        print(f"Output saved to: {output_file}")
        EOF
        
    - name: Commit merged file
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add kimshim.txt
        git commit -m "Merge kim.txt into kimshim.txt and deduplicate" || echo "No changes to commit"
        git push
